<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEè´´å›¾AIå®šåˆ¶æœåŠ¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 0;
        }
        .feature-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .style-option {
            cursor: pointer;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .style-option:hover, .style-option.selected {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .cost-preview {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
        }
        .progress-section {
            background: #d1ecf1;
            border-radius: 8px;
            padding: 20px;
        }
        .phrase-tag {
            display: inline-block;
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 20px;
            padding: 5px 12px;
            margin: 3px;
            cursor: pointer;
        }
        .phrase-tag.selected {
            background: #2196f3;
            color: white;
        }
        .character-preview {
            background: #fff3e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .compliance-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .compliance-pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .compliance-fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-magic"></i> LINEè´´å›¾AIå®šåˆ¶
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">è¿”å›ä¸»é¡µ</a>
            </div>
        </div>
    </nav>

    <!-- è‹±é›„åŒºåŸŸ -->
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">ğŸ¨ ä¸“ä¸šLINEè´´å›¾å®šåˆ¶æœåŠ¡</h1>
            <p class="lead mb-5">AIé©±åŠ¨ Â· 100%åˆè§„ Â· ä¸€é”®ä¸Šä¼ LINEå•†åº—</p>
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card bg-transparent border-light text-white">
                        <div class="card-body">
                            <h5><i class="fas fa-shield-alt"></i> ç‰ˆæƒå®‰å…¨</h5>
                            <p>è‡ªåŠ¨æ£€æµ‹é¿å…ä¾µæƒ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-transparent border-light text-white">
                        <div class="card-body">
                            <h5><i class="fas fa-check-circle"></i> LINEå…¼å®¹</h5>
                            <p>100%ç¬¦åˆå®˜æ–¹æ ‡å‡†</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-transparent border-light text-white">
                        <div class="card-body">
                            <h5><i class="fas fa-dollar-sign"></i> é€æ˜å®šä»·</h5>
                            <p>æˆæœ¬æ˜ç¡®å¯æ§</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container my-5">
        <div class="row">
            <!-- å·¦ä¾§ï¼šå®šåˆ¶è¡¨å• -->
            <div class="col-lg-8">
                <!-- æ­¥éª¤1ï¼šè§’è‰²è®¾å®š -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-edit"></i> æ­¥éª¤1ï¼šè®¾è®¡ä½ çš„è§’è‰²</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="characterName" class="form-label">è§’è‰²åç§°</label>
                            <input type="text" class="form-control" id="characterName" 
                                   placeholder="ä¾‹å¦‚ï¼šæˆ‘å®¶çš„æ©˜çŒ«ã€å¯çˆ±å°ç†ŠçŒ«" maxlength="20">
                            <div class="form-text">å»ºè®®ä½¿ç”¨ç®€æ´æœ‰è¶£çš„åç§°ï¼Œæœ€å¤š20ä¸ªå­—ç¬¦</div>
                        </div>
                        <div class="mb-3">
                            <label for="characterDesc" class="form-label">è§’è‰²æè¿°</label>
                            <textarea class="form-control" id="characterDesc" rows="3" 
                                      placeholder="ä¾‹å¦‚ï¼šä¸€åªçˆ±ç¡è§‰çš„èƒ–æ©˜çŒ«ï¼Œå¾ˆæ¸©æŸ”ï¼Œå–œæ¬¢æ™’å¤ªé˜³" maxlength="100"></textarea>
                            <div class="form-text">è¯¦ç»†æè¿°è§’è‰²çš„å¤–è§‚å’Œæ€§æ ¼ç‰¹ç‚¹ï¼Œæœ€å¤š100ä¸ªå­—ç¬¦</div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="validateCharacter()">
                            <i class="fas fa-shield-check"></i> æ£€æŸ¥åˆè§„æ€§
                        </button>
                        <div id="complianceResult"></div>
                    </div>
                </div>

                <!-- æ­¥éª¤2ï¼šé€‰æ‹©é£æ ¼ -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-palette"></i> æ­¥éª¤2ï¼šé€‰æ‹©è´´å›¾é£æ ¼</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="styleOptions">
                            <div class="col-md-6 col-lg-4">
                                <div class="style-option" data-style="kawaii">
                                    <div class="text-center">
                                        <i class="fas fa-heart fa-2x mb-2 text-pink"></i>
                                        <h6>Kawaii å¯çˆ±èŒç³»</h6>
                                        <small>å¤§çœ¼ç›ã€åœ†æ¶¦ã€è‰²å½©æŸ”å’Œ</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="style-option" data-style="minimal">
                                    <div class="text-center">
                                        <i class="fas fa-circle fa-2x mb-2 text-secondary"></i>
                                        <h6>Minimal ç®€çº¦ç°ä»£</h6>
                                        <small>çº¿æ¡ç®€æ´ã€è‰²å½©ç®€å•</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="style-option" data-style="chibi">
                                    <div class="text-center">
                                        <i class="fas fa-baby fa-2x mb-2 text-warning"></i>
                                        <h6>Chibi Qç‰ˆèŒåŒ–</h6>
                                        <small>å¤§å¤´å°èº«ã€è¶…çº§å¯çˆ±</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="style-option" data-style="mascot">
                                    <div class="text-center">
                                        <i class="fas fa-star fa-2x mb-2 text-info"></i>
                                        <h6>Mascot å‰ç¥¥ç‰©é£</h6>
                                        <small>å‹å¥½äº²åˆ‡ã€ä¼ä¸šçº§å¯ç”¨</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <div class="style-option" data-style="emoji">
                                    <div class="text-center">
                                        <i class="fas fa-smile fa-2x mb-2 text-success"></i>
                                        <h6>Emoji è¡¨æƒ…åŒ…é£</h6>
                                        <small>æƒ…æ„Ÿæ˜ç¡®ã€é€šç”¨æ˜“æ‡‚</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤3ï¼šæ•°é‡å’ŒçŸ­è¯­ -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-list-ol"></i> æ­¥éª¤3ï¼šæ•°é‡å’ŒçŸ­è¯­è®¾ç½®</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stickerCount" class="form-label">è´´å›¾æ•°é‡</label>
                            <select class="form-select" id="stickerCount" onchange="updateCostPreview()">
                                <option value="8">8å¼  - åŸºç¡€å¥—è£…</option>
                                <option value="16">16å¼  - æ ‡å‡†å¥—è£…</option>
                                <option value="24">24å¼  - è±ªåå¥—è£…</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">å¸¸ç”¨çŸ­è¯­</label>
                            <div id="phrasePresets" class="mb-2">
                                <!-- é¢„è®¾çŸ­è¯­æ ‡ç­¾ -->
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="customPhrase" 
                                       placeholder="æ·»åŠ è‡ªå®šä¹‰çŸ­è¯­" maxlength="10">
                                <button class="btn btn-outline-secondary" onclick="addCustomPhrase()">
                                    <i class="fas fa-plus"></i> æ·»åŠ 
                                </button>
                            </div>
                            <div class="form-text">é€‰æ‹©æˆ–æ·»åŠ ä½ æƒ³è¦çš„çŸ­è¯­ï¼Œå°†å‡ºç°åœ¨è´´å›¾ä¸­</div>
                        </div>
                        
                        <div id="selectedPhrases" class="mt-3">
                            <strong>å·²é€‰æ‹©çš„çŸ­è¯­ï¼š</strong>
                            <div id="phrasesList"></div>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤4ï¼šç”Ÿæˆç¡®è®¤ -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-rocket"></i> æ­¥éª¤4ï¼šç¡®è®¤ç”Ÿæˆ</h5>
                    </div>
                    <div class="card-body">
                        <div id="characterPreview" class="character-preview">
                            <h6>ç”Ÿæˆé¢„è§ˆ</h6>
                            <p>è¯·å…ˆå®Œæˆè§’è‰²è®¾å®šå’Œé£æ ¼é€‰æ‹©</p>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-danger btn-lg" 
                                    id="generateBtn" onclick="generateStickers()" disabled>
                                <i class="fas fa-magic"></i> å¼€å§‹ç”ŸæˆLINEè´´å›¾
                            </button>
                        </div>
                        
                        <!-- è¿›åº¦æ˜¾ç¤º -->
                        <div id="progressSection" style="display:none;" class="mt-4 progress-section">
                            <h6><i class="fas fa-cog fa-spin"></i> ç”Ÿæˆè¿›åº¦</h6>
                            <div class="progress mb-2">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="mb-0">å‡†å¤‡ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæˆæœ¬é¢„è§ˆå’Œè¯´æ˜ -->
            <div class="col-lg-4">
                <!-- æˆæœ¬é¢„è§ˆ -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> æˆæœ¬é¢„è§ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="cost-preview" id="costPreview">
                            <div class="text-center">
                                <h3 class="text-primary mb-3">Â¥ <span id="totalCost">--</span></h3>
                                <p class="mb-2">åŒ…å« <span id="costStickerCount">8</span> å¼ è´´å›¾</p>
                                <small class="text-muted">
                                    GPT-4: $<span id="gpt4Cost">--</span> + 
                                    DALL-E: $<span id="dalleCost">--</span>
                                </small>
                            </div>
                        </div>
                        <div class="mt-3" id="costExplanation">
                            <h6>ä»·æ ¼è¯´æ˜</h6>
                            <ul class="list-unstyled small">
                                <li>âœ… åŒ…å«AIç”Ÿæˆè´¹ç”¨</li>
                                <li>âœ… åŒ…å«LINEæ ¼å¼æ‰“åŒ…</li>
                                <li>âœ… åŒ…å«åˆè§„æ€§æ£€æŸ¥</li>
                                <li>âœ… åŒ…å«æŠ€æœ¯æ”¯æŒ</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- åŠŸèƒ½ç‰¹è‰² -->
                <div class="card feature-card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-star"></i> æœåŠ¡ç‰¹è‰²</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item border-0">
                                <i class="fas fa-shield-check text-success"></i>
                                <strong>ç‰ˆæƒä¿æŠ¤</strong><br>
                                <small>è‡ªåŠ¨æ£€æµ‹é¿å…ä¾µæƒé£é™©</small>
                            </div>
                            <div class="list-group-item border-0">
                                <i class="fas fa-check-double text-primary"></i>
                                <strong>LINEå…¼å®¹</strong><br>
                                <small>100%ç¬¦åˆå®˜æ–¹è§„æ ¼è¦æ±‚</small>
                            </div>
                            <div class="list-group-item border-0">
                                <i class="fas fa-magic text-warning"></i>
                                <strong>AIä¼˜åŒ–</strong><br>
                                <small>ä¸“ä¸šæç¤ºè¯å’Œè´¨é‡æ§åˆ¶</small>
                            </div>
                            <div class="list-group-item border-0">
                                <i class="fas fa-download text-info"></i>
                                <strong>å³æ—¶ä¸‹è½½</strong><br>
                                <small>ç”Ÿæˆå®Œæˆç«‹å³å¯ä¸‹è½½ZIP</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨æŒ‡å— -->
                <div class="card feature-card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-question-circle"></i> ä½¿ç”¨æŒ‡å—</h5>
                    </div>
                    <div class="card-body">
                        <ol class="small">
                            <li class="mb-2">å®Œæˆè§’è‰²è®¾å®šå’Œåˆè§„æ£€æŸ¥</li>
                            <li class="mb-2">é€‰æ‹©é€‚åˆçš„è‰ºæœ¯é£æ ¼</li>
                            <li class="mb-2">è®¾ç½®è´´å›¾æ•°é‡å’ŒçŸ­è¯­</li>
                            <li class="mb-2">ç¡®è®¤ä¿¡æ¯åå¼€å§‹ç”Ÿæˆ</li>
                            <li class="mb-2">ä¸‹è½½ZIPæ–‡ä»¶ä¸Šä¼ åˆ°<br>
                                <a href="https://creator.line.me/" target="_blank">LINE Creators Market</a>
                            </li>
                        </ol>
                        <div class="alert alert-warning small mt-3">
                            <strong>æ³¨æ„ï¼š</strong>ä¸Šä¼ æ—¶å¿…é¡»å‹¾é€‰"AI was used"é€‰é¡¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p>&copy; 2024 LINEè´´å›¾AIå®šåˆ¶æœåŠ¡. æ‰€æœ‰æƒåˆ©ä¿ç•™.</p>
            <p><small>è¯·ç¡®ä¿ç”Ÿæˆçš„å†…å®¹ç¬¦åˆLINE Creators Marketè§„èŒƒ</small></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedStyle = 'kawaii';
        let selectedPhrases = [];
        let characterValid = false;
        let apiConfigured = false;
        
        // é¢„è®¾çŸ­è¯­
        const presetPhrases = [
            'ä½ å¥½', 'è°¢è°¢', 'å†è§', 'åŠ æ²¹', 'å¼€å¿ƒ', 'éš¾è¿‡', 'ç”Ÿæ°”', 'çˆ±ä½ ',
            'æ—©ä¸Šå¥½', 'æ™šå®‰', 'å¯¹ä¸èµ·', 'æ²¡å…³ç³»', 'æ£’æ£’', 'å“ˆå“ˆ', 'å—¯å—¯', 'å¥½çš„',
            'æƒ³ä½ ', 'ç´¯äº†', 'é¥¿äº†', 'å›°äº†', 'å¿™ç¢Œ', 'æ”¾æ¾', 'æƒŠè®¶', 'æœŸå¾…'
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkApiStatus();
            initStyleSelection();
            initPhrasePresets();
            updateCostPreview();
            
            // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªé£æ ¼
            document.querySelector('.style-option[data-style="kawaii"]').click();
        });

        // æ£€æŸ¥APIé…ç½®çŠ¶æ€
        async function checkApiStatus() {
            try {
                const response = await fetch('/check_api_status');
                const status = await response.json();
                
                apiConfigured = status.openai_configured;
                
                if (!apiConfigured) {
                    // æ˜¾ç¤ºAPIé…ç½®è­¦å‘Š
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong><i class="fas fa-exclamation-triangle"></i> APIé…ç½®æé†’ï¼š</strong>
                        æ£€æµ‹åˆ°æœªé…ç½®OpenAI APIå¯†é’¥ï¼Œå½“å‰å¤„äºæ¼”ç¤ºæ¨¡å¼ã€‚
                        <br><small>è¦ç”ŸæˆçœŸå®è´´å›¾ï¼Œè¯·åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®æ‚¨çš„OPENAI_API_KEY</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
                    const container = document.querySelector('.container');
                    container.insertBefore(alertDiv, container.firstChild);
                    
                    // æ›´æ–°ç”ŸæˆæŒ‰é’®æ–‡æ¡ˆ
                    const generateBtn = document.getElementById('generateBtn');
                    generateBtn.innerHTML = '<i class="fas fa-magic"></i> æ¼”ç¤ºæ¨¡å¼ï¼šç”Ÿæˆé¢„è§ˆè´´å›¾';
                    
                    // æ›´æ–°æˆæœ¬è¯´æ˜
                    const costExplanation = document.getElementById('costExplanation');
                    costExplanation.innerHTML = `
                        <h6>æ¼”ç¤ºæ¨¡å¼è¯´æ˜</h6>
                        <ul class="list-unstyled small">
                            <li>ğŸ­ ç”Ÿæˆé¢„è§ˆå›¾ç‰‡ï¼ˆéAIç”Ÿæˆï¼‰</li>
                            <li>ğŸ“¦ åŒ…å«LINEæ ¼å¼æ‰“åŒ…</li>
                            <li>ğŸ›¡ï¸ åŒ…å«åˆè§„æ€§æ£€æŸ¥</li>
                            <li>âš ï¸ éœ€è¦APIå¯†é’¥æ‰èƒ½ç”ŸæˆçœŸå®è´´å›¾</li>
                        </ul>
                        <div class="alert alert-info small mt-2">
                            <strong>å¦‚ä½•é…ç½®APIï¼š</strong><br>
                            1. å¤åˆ¶.env.exampleä¸º.env<br>
                            2. åœ¨.envä¸­è®¾ç½®OPENAI_API_KEY<br>
                            3. é‡å¯åº”ç”¨å³å¯ä½¿ç”¨çœŸå®AI
                        </div>
                    `;
                    
                    // æ›´æ–°æˆæœ¬æ˜¾ç¤º
                    document.getElementById('totalCost').textContent = 'å…è´¹';
                    document.getElementById('gpt4Cost').textContent = '0.00';
                    document.getElementById('dalleCost').textContent = '0.00';
                } else {
                    // APIå·²é…ç½®ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
                    console.log('âœ… OpenAI APIå·²é…ç½®ï¼Œå¯ä»¥ç”ŸæˆçœŸå®è´´å›¾');
                    
                    // æ˜¾ç¤ºæˆåŠŸé…ç½®çš„æç¤º
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <strong><i class="fas fa-check-circle"></i> APIå·²é…ç½®ï¼š</strong>
                        OpenAI APIå·²æˆåŠŸé…ç½®ï¼Œå¯ä»¥ç”ŸæˆçœŸå®çš„AIè´´å›¾ï¼
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    const container = document.querySelector('.container');
                    container.insertBefore(alertDiv, container.firstChild);
                }
                
            } catch (error) {
                console.error('APIçŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–é£æ ¼é€‰æ‹©
        function initStyleSelection() {
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', function() {
                    // æ¸…é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
                    // é€‰ä¸­å½“å‰é¡¹
                    this.classList.add('selected');
                    selectedStyle = this.dataset.style;
                    updatePreview();
                });
            });
        }

        // åˆå§‹åŒ–é¢„è®¾çŸ­è¯­
        function initPhrasePresets() {
            const container = document.getElementById('phrasePresets');
            presetPhrases.forEach(phrase => {
                const tag = document.createElement('span');
                tag.className = 'phrase-tag';
                tag.textContent = phrase;
                tag.onclick = () => togglePhrase(phrase, tag);
                container.appendChild(tag);
            });
        }

        // åˆ‡æ¢çŸ­è¯­é€‰æ‹©
        function togglePhrase(phrase, element) {
            const maxCount = parseInt(document.getElementById('stickerCount').value);
            
            if (selectedPhrases.includes(phrase)) {
                selectedPhrases = selectedPhrases.filter(p => p !== phrase);
                element.classList.remove('selected');
            } else if (selectedPhrases.length < maxCount) {
                selectedPhrases.push(phrase);
                element.classList.add('selected');
            } else {
                alert(`æœ€å¤šåªèƒ½é€‰æ‹© ${maxCount} ä¸ªçŸ­è¯­`);
                return;
            }
            
            updatePhrasesDisplay();
            updatePreview();
        }

        // æ·»åŠ è‡ªå®šä¹‰çŸ­è¯­
        function addCustomPhrase() {
            const input = document.getElementById('customPhrase');
            const phrase = input.value.trim();
            const maxCount = parseInt(document.getElementById('stickerCount').value);
            
            if (!phrase) return;
            if (selectedPhrases.includes(phrase)) {
                alert('çŸ­è¯­å·²å­˜åœ¨');
                return;
            }
            if (selectedPhrases.length >= maxCount) {
                alert(`æœ€å¤šåªèƒ½é€‰æ‹© ${maxCount} ä¸ªçŸ­è¯­`);
                return;
            }
            
            selectedPhrases.push(phrase);
            input.value = '';
            updatePhrasesDisplay();
            updatePreview();
        }

        // æ›´æ–°çŸ­è¯­æ˜¾ç¤º
        function updatePhrasesDisplay() {
            const container = document.getElementById('phrasesList');
            container.innerHTML = '';
            
            selectedPhrases.forEach(phrase => {
                const tag = document.createElement('span');
                tag.className = 'badge bg-primary me-1 mb-1';
                tag.innerHTML = `${phrase} <i class="fas fa-times ms-1" onclick="removePhrase('${phrase}')" style="cursor:pointer;"></i>`;
                container.appendChild(tag);
            });
        }

        // ç§»é™¤çŸ­è¯­
        function removePhrase(phrase) {
            selectedPhrases = selectedPhrases.filter(p => p !== phrase);
            updatePhrasesDisplay();
            updatePreview();
            
            // æ›´æ–°é¢„è®¾çŸ­è¯­çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.phrase-tag').forEach(tag => {
                if (tag.textContent === phrase) {
                    tag.classList.remove('selected');
                }
            });
        }

        // éªŒè¯è§’è‰²åˆè§„æ€§
        async function validateCharacter() {
            const character = document.getElementById('characterName').value.trim();
            const description = document.getElementById('characterDesc').value.trim();
            
            if (!character || !description) {
                alert('è¯·å¡«å†™è§’è‰²åç§°å’Œæè¿°');
                return;
            }
            
            const resultDiv = document.getElementById('complianceResult');
            resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> æ£€æŸ¥ä¸­...';
            
            try {
                const response = await fetch('/validate_character', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({character, description})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    characterValid = data.valid;
                    if (data.valid) {
                        resultDiv.innerHTML = `
                            <div class="compliance-status compliance-pass">
                                <i class="fas fa-check-circle"></i> 
                                åˆè§„æ£€æŸ¥é€šè¿‡ (é£é™©ç­‰çº§: ${data.risk_level})
                            </div>`;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="compliance-status compliance-fail">
                                <i class="fas fa-exclamation-triangle"></i> 
                                åˆè§„æ£€æŸ¥å¤±è´¥<br>
                                <small>${data.issues.join(', ')}</small>
                            </div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">æ£€æŸ¥å¤±è´¥: ${data.error}</div>`;
                }
                
                updatePreview();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        // æ›´æ–°æˆæœ¬é¢„è§ˆ
        async function updateCostPreview() {
            const stickerCount = parseInt(document.getElementById('stickerCount').value);
            
            try {
                const response = await fetch('/estimate_custom_cost', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sticker_count: stickerCount})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalCost').textContent = data.cost.rmb;
                    document.getElementById('costStickerCount').textContent = stickerCount;
                    document.getElementById('gpt4Cost').textContent = data.cost.gpt4.toFixed(2);
                    document.getElementById('dalleCost').textContent = data.cost.dalle.toFixed(2);
                }
                
            } catch (error) {
                console.error('æˆæœ¬ä¼°ç®—å¤±è´¥:', error);
            }
            
            // æ›´æ–°çŸ­è¯­é™åˆ¶
            if (selectedPhrases.length > stickerCount) {
                selectedPhrases = selectedPhrases.slice(0, stickerCount);
                updatePhrasesDisplay();
            }
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const character = document.getElementById('characterName').value.trim();
            const description = document.getElementById('characterDesc').value.trim();
            const stickerCount = parseInt(document.getElementById('stickerCount').value);
            
            const previewDiv = document.getElementById('characterPreview');
            
            if (character && description && characterValid && selectedStyle) {
                previewDiv.innerHTML = `
                    <h6>âœ… ç”Ÿæˆé¢„è§ˆ</h6>
                    <p><strong>è§’è‰²ï¼š</strong>${character}</p>
                    <p><strong>æè¿°ï¼š</strong>${description}</p>
                    <p><strong>é£æ ¼ï¼š</strong>${getStyleName(selectedStyle)}</p>
                    <p><strong>æ•°é‡ï¼š</strong>${stickerCount}å¼ </p>
                    <p><strong>çŸ­è¯­ï¼š</strong>${selectedPhrases.join(', ') || 'å°†ä½¿ç”¨é»˜è®¤çŸ­è¯­'}</p>
                `;
                
                document.getElementById('generateBtn').disabled = false;
            } else {
                previewDiv.innerHTML = `
                    <h6>ç”Ÿæˆé¢„è§ˆ</h6>
                    <p>è¯·å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š</p>
                    <ul class="small">
                        ${!character ? '<li>è¾“å…¥è§’è‰²åç§°</li>' : ''}
                        ${!description ? '<li>è¾“å…¥è§’è‰²æè¿°</li>' : ''}
                        ${!characterValid ? '<li>é€šè¿‡åˆè§„æ€§æ£€æŸ¥</li>' : ''}
                        ${!selectedStyle ? '<li>é€‰æ‹©è´´å›¾é£æ ¼</li>' : ''}
                    </ul>
                `;
                
                document.getElementById('generateBtn').disabled = true;
            }
        }

        // è·å–é£æ ¼åç§°
        function getStyleName(style) {
            const names = {
                'kawaii': 'Kawaii å¯çˆ±èŒç³»',
                'minimal': 'Minimal ç®€çº¦ç°ä»£',
                'chibi': 'Chibi Qç‰ˆèŒåŒ–',
                'mascot': 'Mascot å‰ç¥¥ç‰©é£',
                'emoji': 'Emoji è¡¨æƒ…åŒ…é£'
            };
            return names[style] || style;
        }

        // ç”Ÿæˆè´´å›¾
        async function generateStickers() {
            const character = document.getElementById('characterName').value.trim();
            const description = document.getElementById('characterDesc').value.trim();
            const stickerCount = parseInt(document.getElementById('stickerCount').value);
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©çŸ­è¯­ï¼Œä½¿ç”¨é»˜è®¤çŸ­è¯­
            let phrases = selectedPhrases.length > 0 ? selectedPhrases : 
                          presetPhrases.slice(0, stickerCount);
            
            const generateData = {
                character,
                description,
                style: selectedStyle,
                sticker_count: stickerCount,
                phrases
            };
            
            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            
            try {
                const response = await fetch('/generate_custom_stickers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(generateData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // å¼€å§‹è½®è¯¢çŠ¶æ€
                    pollGenerationStatus();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
                    resetGeneration();
                }
                
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                resetGeneration();
            }
        }

        // è½®è¯¢ç”ŸæˆçŠ¶æ€
        async function pollGenerationStatus() {
            try {
                const response = await fetch('/generation_status');
                const status = await response.json();
                
                document.getElementById('progressText').textContent = status.progress;
                
                if (status.running) {
                    // ç»§ç»­è½®è¯¢
                    setTimeout(pollGenerationStatus, 2000);
                } else {
                    // ç”Ÿæˆå®Œæˆ
                    if (status.error) {
                        alert('ç”Ÿæˆå¤±è´¥: ' + status.error);
                    } else {
                        alert('ğŸ‰ LINEè´´å›¾ç”Ÿæˆå®Œæˆï¼è¯·åœ¨ä¸»é¡µä¸‹è½½ZIPæ–‡ä»¶ã€‚');
                        // è·³è½¬åˆ°ä¸»é¡µæŸ¥çœ‹ç»“æœ
                        window.location.href = '/';
                    }
                    resetGeneration();
                }
                
            } catch (error) {
                console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error);
                setTimeout(pollGenerationStatus, 5000);
            }
        }

        // é‡ç½®ç”ŸæˆçŠ¶æ€
        function resetGeneration() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('characterName').addEventListener('input', updatePreview);
        document.getElementById('characterDesc').addEventListener('input', updatePreview);
        document.getElementById('stickerCount').addEventListener('change', function() {
            updateCostPreview();
            updatePreview();
        });
    </script>
</body>
</html>
